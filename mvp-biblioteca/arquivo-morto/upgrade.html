<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localizador de Livros</title>
    <!-- Carrega Tailwind CSS para utilitários -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos personalizados para o mapa e animações -->
    <style>
        /* Estilos globais */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Container do Mapa (Grid 17x17) */
        #map-container {
            display: grid;
            grid-template-columns: repeat(17, minmax(0, 1fr)); 
            grid-template-rows: repeat(17, minmax(0, 1fr));
            width: 100%;
            max-width: 700px;
            aspect-ratio: 1 / 1; /* Quadrado */
            margin: 0 auto;
            border: 1px solid #d1d5db;
        }

        /* Estantes (Shelf Blocks) - Posições Ímpares/Ímpares */
        .shelf-block {
            background-color: #a7f3d0; 
            border: 1px solid #10b981;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: #065f46;
        }

        /* Ruas e Avenidas (Roads and Avenues) - Posições Pares/Ímpares ou Ímpares/Pares */
        .road, .avenue {
            background-color: #fef3c7; /* Amarelo muito claro */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.5rem; 
            font-weight: 400;
            color: #b45309; /* Marrom escuro */
            padding: 1px;
            overflow: hidden;
            white-space: nowrap;
        }

        /* Trajeto (Path) */
        .path {
            background-color: #3b82f6; /* Azul do caminho */
            animation: pulse 1s infinite alternate;
        }

        /* Ponto A (Início) */
        .start-point {
            background-color: #10b981 !important; /* Verde */
            color: white;
            font-weight: 700;
            border: 2px solid #047857;
        }

        /* Ponto B (Livro/Fim) */
        .end-point {
            background-color: #ef4444 !important; /* Vermelho */
            color: white;
            font-weight: 700;
            border: 2px solid #b91c1c;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.8);
        }

        /* Animação para o trajeto */
        @keyframes pulse {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }

        /* Rótulo das Avenidas (vertical) */
        .avenue-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

    <div id="app-container" class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 md:p-10 transition-all duration-500">
        <!-- O conteúdo das telas será injetado pelo JavaScript -->
    </div>

    <!-- Modal para Exibir Detalhes do Livro e o Popup Final -->
    <div id="modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 transition-opacity duration-300">
        <div id="modal-content" class="bg-white rounded-lg p-6 w-full max-w-sm md:max-w-md shadow-xl transform scale-95 transition-transform duration-300">
            <!-- Conteúdo do Modal -->
        </div>
    </div>

    <!-- Lógica da aplicação (JavaScript CONSOLIDADO) -->
    <script>
// --- Configurações e Dados ---
let currentScreen = 'login';
let selectedBookIndex = 0; 

// Estado global para rastrear o ponto inicial do PRÓXIMO trajeto
let currentStartPoint = { row: 0, col: 0 }; // Default: Entrada [0, 0]
// Estado global para armazenar o Ponto B da última pesquisa (o livro encontrado)
let lastBookLocation = { row: 0, col: 0 }; 

// Credenciais de login
const validMatricula = 'unifor'; 
const validSenha = '2025';

// Elementos DOM
const appContainer = document.getElementById('app-container');
const modalOverlay = document.getElementById('modal-overlay');
const modalContent = document.getElementById('modal-content');

const mapData = {
    // Nomes para as 9 Ruas e 9 Avenidas (Grid 17x17)
    ruas: [
        'Rua Lima Barreto', 'Rua Machado de Assis', 'Rua Clarice Lispector', 
        'Rua Eça de Queiroz', 'Rua Jorge Amado', 'Rua José Saramago', 
        'Rua Fernando Pessoa', 'Rua Cora Coralina', 'Rua Guimarães Rosa'
    ],
    avenidas: [
        'Av. Lygia F. Telles', 'Av. Luís Vaz de Camões', 'Av. Cecília Meireles', 
        'Av. Graciliano Ramos', 'Av. Ariano Suassuna', 'Av. Vinicius de Moraes', 
        'Av. Manuel Bandeira', 'Av. Rachel de Queiroz', 'Av. Mia Couto'
    ],
    shelfRowCount: 8, 
    shelfColCount: 8,
};

// Livros cadastrados com localizações específicas
const mockBooks = [
    {
        id: 0,
        title: "Engenharia de Software",
        author: "Ian Sommerville",
        edition: "10ª Edição",
        shelfNumber: 39, // (5ª Linha, 7ª Coluna) no mapa 8x8
        roadIndex: 4, 
        address: "Estante 39, Lado A, Prateleira P3, na Rua Jorge Amado.",
        copies: { disponivel: 2, emprestado: 5, reservado: 1 }
    },
    {
        id: 1,
        title: "Cem Anos de Solidão",
        author: "Gabriel García Márquez",
        edition: "Edição Especial",
        shelfNumber: 1, // (1ª Linha, 1ª Coluna)
        roadIndex: 0, 
        address: "Estante 01, Lado B, Prateleira P1, na Rua Lima Barreto.",
        copies: { disponivel: 1, emprestado: 0, reservado: 0 }
    },
    {
        id: 2,
        title: "A Metamorfose",
        author: "Franz Kafka",
        edition: "Clássico",
        shelfNumber: 64, // (8ª Linha, 8ª Coluna)
        roadIndex: 8, 
        address: "Estante 64, Lado A, Prateleira P5, na Rua Guimarães Rosa.",
        copies: { disponivel: 0, emprestado: 1, reservado: 3 }
    }
];

// --- Funções Auxiliares de Localização ---

/**
 * Converte o número da estante (1-64) em coordenadas no grid 17x17.
 * As estantes ficam nas posições ímpares (1, 3, 5, ..., 15).
 * @param {number} shelfNumber - O número da estante (1 a 64).
 * @returns {{row: number, col: number}} As coordenadas no grid 17x17.
 */
function calculateShelfCoordinates(shelfNumber) {
    const shelfIndex = shelfNumber - 1; // 0 a 63
    const shelfRowIndex = Math.floor(shelfIndex / mapData.shelfColCount); // 0-7 (Linha da estante 8x8)
    const shelfColIndex = shelfIndex % mapData.shelfColCount;             // 0-7 (Coluna da estante 8x8)
    
    // Converte para coordenadas no grid 17x17: 2 * index + 1
    const gridRow = (shelfRowIndex * 2) + 1; 
    const gridCol = (shelfColIndex * 2) + 1; 
    return { row: gridRow, col: gridCol };
}

// --- Funções de Renderização de Telas ---

function renderLoginScreen() {
    appContainer.innerHTML = `
        <div id="login-screen" class="space-y-6">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">Localizador de Livros - Acesso</h2>
            <p class="text-sm text-center text-gray-500">Credenciais de teste: Matrícula unifor | Senha 2025</p>

            <div class="space-y-4">
                <label class="block text-gray-700 font-semibold" for="matricula">Matrícula</label>
                <input id="matricula" type="text" placeholder="Sua Matrícula (Ex: unifor)"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition duration-150">
            </div>

            <div class="space-y-4">
                <label class="block text-gray-700 font-semibold" for="senha">Senha</label>
                <input id="senha" type="password" placeholder="Sua Senha (Ex: 2025)"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition duration-150">
            </div>

            <div id="login-error" class="text-red-500 text-center font-medium hidden"></div>

            <button id="login-button"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.01]">
                Acessar
            </button>
        </div>
    `;
    document.getElementById('login-button').addEventListener('click', handleLogin);
}

function renderSearchScreen() {
    // Encontra o livro atualmente selecionado para pré-preencher
    const currentBook = mockBooks[selectedBookIndex];
    // Formata o local atual para exibição na tela de pesquisa
    const startPointLabel = currentStartPoint.row === 0 && currentStartPoint.col === 0 
        ? "Entrada Principal" 
        : `Estante E${getShelfNumberFromCoords(currentStartPoint)}`;

    appContainer.innerHTML = `
        <div id="search-screen" class="space-y-8">
            <h2 class="text-3xl font-bold text-gray-800 text-center">Localizador de Livros - Pesquisa</h2>

            <div class="p-3 bg-blue-50 border-l-4 border-blue-400 rounded-md">
                <p class="font-semibold text-blue-800">Seu Local Atual (Ponto A):</p>
                <p class="text-blue-600">${startPointLabel}</p>
            </div>

            <div class="space-y-4">
                <label class="block text-gray-700 font-semibold" for="book-select">Livro e Autor</label>
                <select id="book-select" 
                    class="w-full p-3 border border-gray-300 bg-white rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition duration-150">
                    ${mockBooks.map((book, index) => `
                        <option value="${index}" ${selectedBookIndex === index ? 'selected' : ''}>
                            ${book.title}, ${book.author}
                        </option>
                    `).join('')}
                </select>
                <p class="text-xs text-gray-500 mt-1">Selecione o livro para simular a busca.</p>
            </div>
            
            <div id="selected-book-info" class="p-4 bg-gray-50 rounded-lg border">
                <p class="text-sm font-semibold text-gray-700">Livro Selecionado:</p>
                <p class="text-lg font-bold text-indigo-600">${currentBook.title}</p>
                <p class="text-sm text-gray-500">Autor: ${currentBook.author}</p>
            </div>

            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="search-book-button"
                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.01]">
                    Ver Endereço e Status do Livro
                </button>
                <button id="generate-route-button"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.01]">
                    Gerar Trajeto
                </button>
            </div>
        </div>
    `;
    
    // Listener para atualizar o livro selecionado na UI
    document.getElementById('book-select').addEventListener('change', (e) => {
        selectedBookIndex = parseInt(e.target.value);
        const bookInfoDiv = document.getElementById('selected-book-info');
        const book = mockBooks[selectedBookIndex];
        bookInfoDiv.innerHTML = `
            <p class="text-sm font-semibold text-gray-700">Livro Selecionado:</p>
            <p class="text-lg font-bold text-indigo-600">${book.title}</p>
            <p class="text-sm text-gray-500">Autor: ${book.author}</p>
        `;
    });

    document.getElementById('search-book-button').addEventListener('click', showBookDetails);
    document.getElementById('generate-route-button').addEventListener('click', () => {
        currentScreen = 'route';
        renderApp();
    });
}

function renderRouteScreen() {
    const currentBook = mockBooks[selectedBookIndex];

    appContainer.innerHTML = `
        <div id="route-screen" class="space-y-6">
            <h2 class="text-3xl font-bold text-gray-800 text-center">Trajeto até o Livro</h2>
            <p class="text-center text-gray-600">
                O mapa exibe a rota do seu Ponto A atual até o Ponto B (Estante).
            </p>
            <div id="map-container" class="shadow-xl rounded-lg overflow-hidden">
                <!-- O mapa da biblioteca será renderizado aqui -->
            </div>
            <div class="text-center text-sm font-medium text-gray-700">
                 Livro: <span class="text-indigo-600 font-bold">${currentBook.title}</span><br>
                 Localização: <span class="text-red-500 font-bold">${currentBook.address}</span>
            </div>

            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-6">
                <button id="concluir-pesquisa-button"
                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.01]">
                    Concluir Pesquisa (Livro Encontrado)
                </button>
                <button id="back-to-search-button"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg shadow-lg transition duration-150 ease-in-out transform hover:scale-[1.01]">
                    Voltar à Pesquisa
                </button>
            </div>
        </div>
    `;
    drawLibraryMap(currentBook);
    
    // Listeners para os botões da tela de rota
    document.getElementById('concluir-pesquisa-button').addEventListener('click', showFinalPopup); 
    document.getElementById('back-to-search-button').addEventListener('click', () => {
        currentScreen = 'search';
        renderApp();
    });
}

// --- Funções de Lógica e Navegação ---

function handleLogin() {
    const matricula = document.getElementById('matricula').value;
    const senha = document.getElementById('senha').value;
    const errorDiv = document.getElementById('login-error');

    errorDiv.classList.add('hidden');

    if (matricula === validMatricula && senha === validSenha) {
        currentScreen = 'search';
        // Resetar o ponto inicial para a entrada ao logar, caso não esteja lá.
        currentStartPoint = { row: 0, col: 0 };
        renderApp();
    } else {
        errorDiv.textContent = 'Matrícula ou senha inválida. Tente novamente.';
        errorDiv.classList.remove('hidden');
    }
}

function showBookDetails() {
    const currentBook = mockBooks[selectedBookIndex];
    const copies = currentBook.copies;

    modalContent.innerHTML = `
        <h3 class="text-2xl font-bold text-gray-800 mb-4">Detalhes e Status do Livro</h3>
        <div class="space-y-3 text-gray-700">
            <p><strong>Título:</strong> ${currentBook.title}</p>
            <p><strong>Autor:</strong> ${currentBook.author}</p>
            <p><strong>Edição:</strong> ${currentBook.edition}</p>

            <div class="border-t pt-3 mt-3">
                <p class="font-semibold text-gray-800 mb-2">Status de Cópias:</p>
                <ul class="space-y-1 text-sm">
                    <li class="flex justify-between">
                        <span class="text-green-600 font-medium">Disponível:</span> 
                        <span class="font-bold">${copies.disponivel}</span>
                    </li>
                    <li class="flex justify-between">
                        <span class="text-red-600 font-medium">Emprestado:</span> 
                        <span class="font-bold">${copies.emprestado}</span>
                    </li>
                    <li class="flex justify-between">
                        <span class="text-yellow-600 font-medium">Reservado:</span> 
                        <span class="font-bold">${copies.reservado}</span>
                    </li>
                </ul>
            </div>

            <p class="text-lg font-semibold text-red-600 border-t pt-3 mt-3">
                Endereço na Biblioteca: <br>
                ${currentBook.address}
            </p>
        </div>
        <button id="close-modal"
            class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition duration-150">
            Fechar
        </button>
    `;
    modalOverlay.classList.remove('hidden');
    modalOverlay.classList.add('flex');
    document.getElementById('close-modal').addEventListener('click', closeModal);
}

/**
 * Função que esconde o modal.
 */
function closeModal() {
    modalOverlay.classList.add('hidden');
    modalOverlay.classList.remove('flex');
}

function showFinalPopup() {
    modalContent.innerHTML = `
        <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">Fim do Trajeto!</h3>
        <p class="text-center text-gray-700 mb-6">
            Você chegou ao endereço do livro. Deseja pesquisar outro livro ou sair do programa?
        </p>
        <div class="flex space-x-4">
            <button id="search-again-button"
                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition duration-150">
                Pesquisar Outro
            </button>
            <button id="exit-program-button"
                class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition duration-150">
                Sair
            </button>
        </div>
    `;
    modalOverlay.classList.remove('hidden');
    modalOverlay.classList.add('flex');
    
    // Listener para o encadeamento de pesquisa
    document.getElementById('search-again-button').addEventListener('click', () => {
        closeModal();
        // CRUCIAL: Define o Ponto B da última pesquisa (lastBookLocation) como o novo Ponto A (currentStartPoint)
        currentStartPoint = { ...lastBookLocation }; // Usa spread para evitar referência direta
        currentScreen = 'search';
        renderApp();
    });

    document.getElementById('exit-program-button').addEventListener('click', () => {
        closeModal();
        // Redefine para o ponto inicial de entrada ao sair.
        currentStartPoint = { row: 0, col: 0 }; 
        currentScreen = 'login';
        renderApp();
    });
}

/**
 * Retorna o número da estante (1-64) a partir das coordenadas do grid 17x17.
 * @param {{row: number, col: number}} coords - As coordenadas.
 * @returns {number} O número da estante.
 */
function getShelfNumberFromCoords(coords) {
    if (coords.row % 2 === 0 || coords.col % 2 === 0) {
        return 0; // Não é uma estante
    }
    const shelfRowIndex = (coords.row - 1) / 2;
    const shelfColIndex = (coords.col - 1) / 2;
    return (shelfRowIndex * mapData.shelfColCount) + shelfColIndex + 1;
}

/**
 * Desenha o mapa da biblioteca 17x17 e o trajeto do Ponto A (Local Atual) ao Ponto B (Livro).
 */
function drawLibraryMap(currentBook) {
    const mapDiv = document.getElementById('map-container');
    if (!mapDiv) return;

    mapDiv.innerHTML = '';
    
    const startPoint = currentStartPoint; 
    const endPoint = calculateShelfCoordinates(currentBook.shelfNumber);
    lastBookLocation = endPoint; // Salva o ponto B para ser o novo ponto A na próxima busca

    // --- Lógica de Geração do Trajeto (Caminho Reto L) ---
    const pathSet = new Set();
    const r_start = startPoint.row;
    const c_start = startPoint.col;
    const r_end = endPoint.row;
    const c_end = endPoint.col;
    
    // 1. Segmento Horizontal (movimento de coluna, mantendo a linha inicial: R_A)
    const minC = Math.min(c_start, c_end);
    const maxC = Math.max(c_start, c_end);
    for (let c = minC; c <= maxC; c++) {
        pathSet.add(`${r_start}-${c}`);
    }
    
    // 2. Segmento Vertical (movimento de linha, mantendo a coluna final: C_B)
    const minR = Math.min(r_start, r_end);
    const maxR = Math.max(r_start, r_end);
    for (let r = minR; r <= maxR; r++) {
        pathSet.add(`${r}-${c_end}`);
    }

    const finalPathCells = Array.from(pathSet);

    // --- Construção do Grid 17x17 ---
    let shelfCounter = 1;
    const gridSize = 17;

    for (let r = 0; r < gridSize; r++) {
        for (let c = 0; c < gridSize; c++) {
            const cell = document.createElement('div');
            cell.classList.add('w-full', 'h-full', 'grid-cell');
            cell.dataset.row = r;
            cell.dataset.col = c;
            cell.id = `cell-${r}-${c}`;

            // Posição de Estante (Ímpar, Ímpar)
            if (r % 2 !== 0 && c % 2 !== 0) {
                cell.classList.add('shelf-block');
                cell.textContent = `E${shelfCounter}`;
                cell.title = `Estante ${shelfCounter}`;

                // Marcar o Ponto B (Livro)
                if (r === endPoint.row && c === endPoint.col) {
                    cell.classList.add('end-point');
                    cell.textContent = 'Ponto B (Livro)';
                }
                shelfCounter++;

            // Posição de Rua (Par, Ímpar)
            } else if (r % 2 === 0 && c % 2 !== 0) {
                cell.classList.add('road', 'row-separator');
                cell.textContent = mapData.ruas[r / 2];
                cell.title = mapData.ruas[r / 2];

            // Posição de Avenida (Ímpar, Par)
            } else if (r % 2 !== 0 && c % 2 === 0) {
                cell.classList.add('avenue', 'avenue-label');
                cell.textContent = mapData.avenidas[c / 2];
                cell.title = mapData.avenidas[c / 2];

            // Posição de Cruzamento (Par, Par)
            } else if (r % 2 === 0 && c % 2 === 0) {
                cell.classList.add('road', 'avenue', 'bg-red-200');
                cell.textContent = 'X';
                cell.title = `Cruzamento ${mapData.ruas[r / 2]} / ${mapData.avenidas[c / 2]}`;
            }

            // --- Aplicação do Trajeto ---
            const cellId = `${r}-${c}`;
            
            if (finalPathCells.includes(cellId)) {
                cell.classList.add('path');
                // Se for estrada, só pinta. Se for cruzamento (X), mantém o X.
                if (cell.textContent !== 'X' && cell.classList.contains('road')) { 
                    cell.textContent = ''; 
                }
            }

            // Marcar o Ponto A (Início)
            if (r === startPoint.row && c === startPoint.col) {
                cell.classList.remove('path');
                cell.classList.add('start-point', 'bg-green-600');
                cell.textContent = 'Ponto A (Você está Aqui)';
            }
            // Ponto A não deve sobrepor o Ponto B (no caso de A=B)
            if (r === endPoint.row && c === endPoint.col && r === startPoint.row && c === startPoint.col) {
                cell.classList.remove('start-point');
            }
            
            mapDiv.appendChild(cell);
        }
    }
}

// --- Função de Início da Aplicação (Router) ---
function renderApp() {
    // Ajusta a largura máxima do container baseada na tela
    appContainer.classList.remove('max-w-4xl', 'max-w-md', 'max-w-xl');

    if (currentScreen === 'login') {
        appContainer.classList.add('max-w-md');
        renderLoginScreen();
    } else if (currentScreen === 'search') {
        appContainer.classList.add('max-w-xl');
        renderSearchScreen();
    } else if (currentScreen === 'route') {
        appContainer.classList.add('max-w-4xl');
        renderRouteScreen();
    }
}

// Inicializa a aplicação na tela de Login após o carregamento do DOM
document.addEventListener('DOMContentLoaded', () => {
     renderApp();
     // Inicializa o Listener para fechar o modal ao clicar fora
     modalOverlay.addEventListener('click', (e) => {
         if (e.target === modalOverlay) {
             closeModal();
         }
     });
});
    </script>
</body>
</html>